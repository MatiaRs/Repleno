<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="/icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repleno - Iniciar Sesión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #F7F8FC;
            --bg-card: #FFFFFF;
            --border-color: #E2E8F0;
            --accent-primary: #4338CA;
            --accent-secondary: #7C3AED;
            --text-dark: #1E293B;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-dark); }
        .card { background-color: var(--bg-card); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05); }
        .btn-primary { background-color: var(--accent-primary); color: white; border: 1px solid var(--accent-primary); padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .fade-in { animation: fadeIn 0.8s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .logo-path { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: draw 2s ease-in-out forwards; }
        @keyframes draw { to { stroke-dashoffset: 0; } }
        .screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 100;
            transform: translateX(120%);
            transition: transform 0.5s ease-in-out;
        }
        .notification.show { transform: translateX(0); }
        .notification.error { background-color: #DC2626; }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="notification-area"></div>

    <div id="login-screen" class="screen">
        <div class="card w-full max-w-sm text-center p-8 fade-in">
             <div class="flex justify-center items-center gap-4 mb-4">
                 <svg id="replenoLogoLogin" width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:var(--accent-secondary);stop-opacity:1" />
                            <stop offset="100%" style="stop-color:var(--accent-primary);stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path class="logo-path" d="M20,80 V40 C20,25 30,20 45,20 H70" stroke="url(#logoGradient)" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    <path class="logo-path" style="animation-delay: 0.3s;" d="M45,50 H80 V80 H45 Z" stroke="url(#logoGradient)" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    <path class="logo-path" style="animation-delay: 0.6s;" d="M55,60 V70" stroke="url(#logoGradient)" stroke-width="6" fill="none" stroke-linecap="round"/>
                    <path class="logo-path" style="animation-delay: 0.8s;" d="M68,55 V70" stroke="url(#logoGradient)" stroke-width="6" fill="none" stroke-linecap="round"/>
                </svg>
                 <h1 class="text-4xl font-extrabold text-slate-900">Repleno</h1>
            </div>
            <p class="text-slate-500 mb-6">Inicia sesión para continuar</p>
            <div class="text-left space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-slate-600 mb-1">Usuario</label>
                    <input type="text" id="username" class="w-full bg-white border border-slate-300 rounded-lg p-3 text-slate-900 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-slate-600 mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full bg-white border border-slate-300 rounded-lg p-3 text-slate-900 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <button id="loginBtn" class="btn-primary w-full mt-6">Iniciar Sesión</button>

            <button id="open-register" class="btn-primary w-full mt-6">Registrarse</button>


        </div>
    </div>
    
    <div id="changePasswordModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="card w-full max-w-sm text-center p-8 fade-in">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Cambio de Contraseña Requerido</h3>
            <p class="text-slate-500 mb-6">Por tu seguridad, debes establecer una nueva contraseña para tu cuenta.</p>
            <div class="text-left space-y-4">
                <div>
                    <label for="newPassword" class="block text-sm font-medium text-slate-600 mb-1">Nueva Contraseña</label>
                    <input type="password" id="newPassword" class="w-full bg-white border border-slate-300 rounded-lg p-3">
                </div>
                 <div>
                    <label for="confirmNewPassword" class="block text-sm font-medium text-slate-600 mb-1">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirmNewPassword" class="w-full bg-white border border-slate-300 rounded-lg p-3">
                </div>
            </div>
            <button id="updatePasswordBtn" class="btn-primary w-full mt-6">Actualizar Contraseña</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

 const firebaseConfig = {
    apiKey: "AIzaSyDxfrtCe1RQpFWHewa_kg1WAUmhtifNmI8",
    authDomain: "repleno-app.firebaseapp.com",
    projectId: "repleno-app",
    storageBucket: "repleno-app.firebasestorage.app",
    messagingSenderId: "705634142025",
    appId: "1:705634142025:web:206f1a905f41ad79143c98",
    measurementId: "G-FLTS8BFB46"
  };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const loginScreen = document.getElementById('login-screen');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const loginBtn = document.getElementById('loginBtn');
        const updatePasswordBtn = document.getElementById('updatePasswordBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const notificationArea = document.getElementById('notification-area');

        function showNotification(message, type = 'error') {
            const notif = document.createElement('div');
            notif.className = `notification ${type} show`;
            notif.textContent = message;
            notificationArea.appendChild(notif);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 500);
            }, 3000);
        }

        async function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            if (!username || !password) {
                showNotification('Por favor, ingresa usuario y contraseña.');
                return;
            }

            const q = query(collection(db, "users"), where("username", "==", username));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showNotification('Usuario o contraseña incorrectos.');
                return;
            }

            const userDoc = querySnapshot.docs[0];
            const user = userDoc.data();

            if (user.password === password) {
                sessionStorage.setItem('loggedInUserId', userDoc.id);
                if (user.role === 'admin') {
                    window.location.href = './admin.html';
                } else if (user.mustChangePassword) {
                    changePasswordModal.classList.remove('hidden');
                    changePasswordModal.classList.add('flex');
                } else {
                    window.location.href = './dashboard.html';
                }
            } else {
                showNotification('Usuario o contraseña incorrectos.');
            }
        }
        
        async function handleUpdatePassword() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmNewPasswordInput.value;
            const userId = sessionStorage.getItem('loggedInUserId');

            if (newPassword.length < 6) {
                showNotification('La contraseña debe tener al menos 6 caracteres.');
                return;
            }
            if (newPassword !== confirmPassword) {
                showNotification('Las contraseñas no coinciden.');
                return;
            }

            const userRef = doc(db, "users", userId);
            await setDoc(userRef, { 
                password: newPassword,
                mustChangePassword: false 
            }, { merge: true });
            
            window.location.href = './dashboard.html';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            sessionStorage.removeItem('loggedInUserId');
        });

        loginBtn.addEventListener('click', handleLogin);
        updatePasswordBtn.addEventListener('click', handleUpdatePassword);
    </script>
    <!-- Modal de Registro -->
<div id="register-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96 relative">
    <h2 class="text-2xl font-bold mb-4 text-center">Registro de Usuario</h2>
    <form id="register-form" class="space-y-3">
      <input type="text" id="register-rut" placeholder="RUT" class="w-full p-2 border rounded" required>
      <input type="text" id="register-nombre" placeholder="Nombre" class="w-full p-2 border rounded" required>
      <input type="text" id="register-apellido" placeholder="Apellido" class="w-full p-2 border rounded" required>
      <input type="email" id="register-email" placeholder="Correo electrónico" class="w-full p-2 border rounded" required>
      <input type="tel" id="register-phone" placeholder="Número telefónico" class="w-full p-2 border rounded" required>
      <input type="text" id="register-negocio" placeholder="Nombre del negocio" class="w-full p-2 border rounded" required>
      <input type="password" id="register-password" placeholder="Contraseña" class="w-full p-2 border rounded" required>

      <div class="flex items-start space-x-2 text-sm">
        <input type="checkbox" id="accept-terms" required>
        <label for="accept-terms">
          He leído y acepto los 
          <button type="button" id="open-terms" class="text-blue-600 underline hover:text-blue-800">Términos y Condiciones</button>
        </label>
      </div>

      <button type="submit" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">Registrarse</button>
    </form>
    <button id="close-register" class="absolute top-2 right-3 text-gray-600 hover:text-black">✖</button>
  </div>
</div>

<!-- Modal de Términos y Condiciones -->
<div id="terms-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-auto">
  <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 max-w-3xl relative max-h-[80vh] overflow-y-auto">
    <h2 class="text-2xl font-bold mb-4 text-center">Términos y Condiciones</h2>
    <div class="text-sm text-gray-700 whitespace-pre-line">
      Aceptación de los Términos
        1. Aceptación de los Términos Al registrarse, acceder o utilizar el servicio de suscripción (en adelante, el “Servicio”), usted (el “Cliente”) acepta plenamente estos Términos y Condiciones de Uso (los “T&C”), junto con la Política de Privacidad del proveedor (el “Proveedor”). Si no está de acuerdo con estos T&C, no debe utilizar el Servicio. El uso continuado del mismo constituirá su aceptación de los T&C vigentes, incluidas sus modificaciones. El Proveedor podrá modificar estos T&C en cualquier momento. Dichas modificaciones serán notificadas mediante correo electrónico registrado o a través de la plataforma con al menos 15 días de anticipación a su entrada en vigor.
        2. Descripción del Servicio El Servicio consiste en una plataforma de software como servicio (SaaS) basada en inteligencia artificial y machine learning, diseñada para predecir la demanda futura de productos y optimizar la gestión de inventario y compras del cliente. El funcionamiento del sistema se basa en el análisis de datos históricos y operacionales proporcionados por el Cliente, incluyendo información de ventas, inventario y otras variables relevantes, los cuales pueden ser cargados mediante archivos CSV u otros formatos compatibles. El Cliente comprende y acepta que: Las predicciones entregadas por el sistema son recomendaciones probabilísticas, no garantías de resultados. El sistema puede sugerir o autorizar automáticamente órdenes de compra o venta, conforme a los umbrales de decisión configurados por el cliente. La decisión final de ejecución y las consecuencias comerciales o financieras derivadas del uso del Servicio son de exclusiva responsabilidad del Cliente. El desempeño del modelo depende de la calidad, integridad y consistencia de los datos suministrados.
        3. Suscripción, Pago y Renovación Modalidad: El Servicio se ofrece bajo una suscripción periódica (mensual, trimestral o anual), con pago anticipado. Precios: Los valores vigentes de suscripción se indican en la página web del Servicio. El Proveedor podrá modificarlos previo aviso de 30 días conforme al artículo 28 de la Ley N° 19.496 sobre Protección de los Derechos de los Consumidores. Renovación: La suscripción se renovará automáticamente, salvo que el Cliente la cancele con al menos 7 días hábiles de anticipación al vencimiento del período contratado. Cancelación: El Cliente podrá cancelar su suscripción en cualquier momento desde su panel de usuario. La cancelación surtirá efecto al término del ciclo vigente. No se otorgarán reembolsos por períodos no utilizados, salvo disposición legal en contrario.
        4. Obligaciones del Cliente Exactitud de los Datos: El Cliente es responsable de que los datos cargados (ventas, inventario, precios, etc.) sean veraces, completos y legalmente obtenidos. Derechos sobre la Información: El Cliente declara contar con todos los derechos necesarios sobre los datos que carga al sistema, manteniendo indemne al Proveedor ante cualquier reclamo de terceros. Uso Legítimo: El Cliente se compromete a utilizar el Servicio únicamente para fines comerciales legítimos, conforme a la legislación chilena aplicable. Confidencialidad de Acceso: El Cliente deberá resguardar sus credenciales de acceso y notificar de inmediato cualquier uso no autorizado.
        5. Propiedad Intelectual Todo el software, algoritmos de predicción, modelos estadísticos, diseños, interfaces y documentación asociados al Servicio son propiedad exclusiva del Proveedor y están protegidos por la legislación chilena e internacional sobre propiedad intelectual e industrial. El Cliente conserva todos los derechos sobre los datos que carga y sobre los informes o resultados generados por el sistema. El Proveedor podrá utilizar dichos datos de manera anonimizada y agregada con fines estadísticos o de mejora del modelo, sin identificar al Cliente o su negocio. Durante la vigencia de la suscripción, el Cliente recibe una licencia de uso no exclusiva, intransferible y revocable del Servicio.
        6. Limitación de Responsabilidad El Proveedor no garantiza la exactitud, disponibilidad o rendimiento absoluto de las predicciones generadas por el Servicio. En ningún caso será responsable por: Pérdidas económicas derivadas de decisiones basadas en las predicciones (desabastecimiento, exceso de stock, etc.). Interrupciones del Servicio por mantenimiento, actualizaciones o causas de fuerza mayor. Daños indirectos, incidentales o consecuentes. En conformidad con la legislación chilena, la responsabilidad máxima y acumulativa del Proveedor no excederá el monto efectivamente pagado por el Cliente durante los tres (3) meses anteriores al evento que dio origen al reclamo.
        7. Tratamiento de Datos Personales De acuerdo con la Ley N° 19.628 sobre Protección de la Vida Privada, el Proveedor actuará: Como Encargado del Tratamiento respecto de los datos de inventario, ventas y demás información operativa del Cliente. Como Responsable del Tratamiento respecto de los datos personales de registro (nombre, correo, información de pago, etc.). El Cliente otorga su consentimiento expreso para el tratamiento de dichos datos con el fin de prestar, gestionar y mejorar el Servicio. El Proveedor implementará medidas técnicas y organizativas adecuadas para proteger los datos contra acceso, alteración o divulgación no autorizada. Al finalizar la suscripción, los datos del Cliente serán eliminados de forma segura dentro de un plazo máximo de 30 días, salvo obligación legal de conservación.
        8. Suspensión y Terminación del Servicio El Proveedor podrá suspender o cancelar el acceso al Servicio en caso de: Incumplimiento de los presentes T&C. Uso indebido, fraudulento o contrario a la ley. Falta de pago dentro del plazo establecido. En dichos casos, el Proveedor podrá eliminar los datos del Cliente transcurridos 30 días desde la suspensión definitiva.
        9. Ley Aplicable y Jurisdicción Estos T&C se rigen por las leyes de la República de Chile. Cualquier controversia será sometida a los tribunales ordinarios de justicia de la ciudad de Santiago, sin perjuicio de que las partes procuren previamente una solución mediante mecanismos de mediación o arbitraje voluntario.
    
    </div>
    <button id="close-terms" class="absolute top-2 right-3 text-gray-600 hover:text-black">✖</button>
  </div>
</div>

<!-- Script para abrir/cerrar modales -->
<script>
  const openRegister = document.getElementById('open-register');
  const registerModal = document.getElementById('register-modal');
  const closeRegister = document.getElementById('close-register');
  const openTerms = document.getElementById('open-terms');
  const termsModal = document.getElementById('terms-modal');
  const closeTerms = document.getElementById('close-terms');

  openRegister.addEventListener('click', () => registerModal.classList.remove('hidden'));
  closeRegister.addEventListener('click', () => registerModal.classList.add('hidden'));
  openTerms.addEventListener('click', () => termsModal.classList.remove('hidden'));
  closeTerms.addEventListener('click', () => termsModal.classList.add('hidden'));
</script>

</body>
</html>

