<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="/icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repleno - Iniciar Sesión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #F7F8FC;
            --bg-card: #FFFFFF;
            --border-color: #E2E8F0;
            --accent-primary: #4338CA;
            --accent-secondary: #7C3AED;
            --text-dark: #1E293B;
            --text-muted: #64748B;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-dark); }
        .card { background-color: var(--bg-card); border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .btn-primary { background-color: var(--accent-primary); color: white; border: 1px solid var(--accent-primary); padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .btn-primary:disabled { background-color: #A5B4FC; cursor: not-allowed; }
        .fade-in { animation: fadeIn 0.8s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.5s ease-in-out;
        }
        .notification.show { transform: translateX(0); }
        .notification.error { background-color: #DC2626; }
        .notification.success { background-color: #16A34A; }

        /* Estilos para el Modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-hidden .modal-content {
            transform: scale(0.95) translateY(10px);
        }
        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-visible .modal-content {
            transform: scale(1) translateY(0);
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="notification-area"></div>

    <div id="login-screen" class="screen">
        <div class="card w-full max-w-sm text-center p-8 fade-in">
             <div class="flex justify-center items-center gap-4 mb-4">
                 <svg id="replenoLogoLogin" width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                     <defs>
                         <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                             <stop offset="0%" style="stop-color:var(--accent-secondary);stop-opacity:1" />
                             <stop offset="100%" style="stop-color:var(--accent-primary);stop-opacity:1" />
                         </linearGradient>
                     </defs>
                     <path d="M20,80 V40 C20,25 30,20 45,20 H70" stroke="url(#logoGradient)" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                     <path d="M45,50 H80 V80 H45 Z" stroke="url(#logoGradient)" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                     <path d="M55,60 V70" stroke="url(#logoGradient)" stroke-width="6" fill="none" stroke-linecap="round"/>
                     <path d="M68,55 V70" stroke="url(#logoGradient)" stroke-width="6" fill="none" stroke-linecap="round"/>
                 </svg>
                 <h1 class="text-4xl font-extrabold text-slate-900">Repleno</h1>
             </div>
             <p class="text-slate-500 mb-6">Inicia sesión para continuar</p>
             <div class="text-left space-y-4">
                 <div>
                     <label for="email" class="block text-sm font-medium text-slate-600 mb-1">Correo Electrónico</label>
                     <input type="text" id="email" class="w-full bg-white border border-slate-300 rounded-lg p-3 text-slate-900 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none" autocomplete="email">
                 </div>
                 <div>
                     <label for="password" class="block text-sm font-medium text-slate-600 mb-1">Contraseña</label>
                     <input type="password" id="password" class="w-full bg-white border border-slate-300 rounded-lg p-3 text-slate-900 focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none" autocomplete="current-password">
                 </div>
             </div>
             <button id="loginBtn" class="btn-primary w-full mt-6">Iniciar Sesión</button>
             <p class="text-center text-sm text-slate-500 mt-6">
                ¿No tienes una cuenta? 
                <button id="open-register" class="font-semibold text-indigo-600 hover:text-indigo-500 focus:outline-none focus:underline transition ease-in-out duration-150">
                    Regístrate aquí
                </button>
            </p>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDxfrtCe1RQpFWHewa_kg1WAUmhtifNmI8",
        authDomain: "repleno-app.firebaseapp.com",
        projectId: "repleno-app",
        storageBucket: "repleno-app.firebasestorage.app",
        messagingSenderId: "705634142025",
        appId: "1:705634142025:web:206f1a905f41ad79143c98",
        measurementId: "G-FLTS8BFB46"
    };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const loginBtn = document.getElementById('loginBtn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const notificationArea = document.getElementById('notification-area');
        const openRegisterBtn = document.getElementById('open-register');

        function showNotification(message, type = 'error') {
            const notif = document.createElement('div');
            notif.className = `notification ${type} show`;
            notif.textContent = message;
            notificationArea.appendChild(notif);
            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 500);
            }, 3000);
        }

        async function handleLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!email || !password) {
                showNotification('Por favor, ingresa correo y contraseña.');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    sessionStorage.setItem('loggedInUserId', user.uid);
                    if (userData.role === 'admin') {
                        window.location.href = getAbsoluteUrl('admin.html');
                    } else {
                        window.location.href = getAbsoluteUrl('dashboard.html');
                    }
                } else {
                    showNotification('No se encontraron datos asociados a esta cuenta.');
                    auth.signOut();
                }
            } catch (error) {
                console.error("Login Error:", error.code);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential' || error.code === 'auth/invalid-email') {
                    showNotification('Correo o contraseña incorrectos.');
                } else {
                    showNotification('Ocurrió un error al iniciar sesión.');
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            sessionStorage.removeItem('loggedInUserId');
        });

        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        // --- LÓGICA DE MODALES ---
        const registerModal = document.getElementById('register-modal');
        const termsModal = document.getElementById('terms-modal');
        const openTermsBtn = document.getElementById('open-terms');
        const closeRegisterBtn = document.getElementById('close-register');
        const closeTermsBtn = document.getElementById('close-terms');

        function showModal(modal) {
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            modal.setAttribute('aria-hidden', 'false');
        }

        function hideModal(modal) {
            modal.classList.add('modal-hidden');
            modal.classList.remove('modal-visible');
            modal.setAttribute('aria-hidden', 'true');
        }

        openRegisterBtn.addEventListener('click', () => showModal(registerModal));
        closeRegisterBtn.addEventListener('click', () => hideModal(registerModal));
        registerModal.addEventListener('click', (e) => {
            if (e.target === registerModal) hideModal(registerModal);
        });

        openTermsBtn.addEventListener('click', (e) => {
            e.preventDefault(); // Evita el submit del formulario
            showModal(termsModal);
        });
        closeTermsBtn.addEventListener('click', () => hideModal(termsModal));
        termsModal.addEventListener('click', (e) => {
            if (e.target === termsModal) hideModal(termsModal);
        });
        
        // --- LÓGICA DE REGISTRO ---
        const registerForm = document.getElementById('register-form');
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const rut = document.getElementById('register-rut').value.trim();
            const nombre = document.getElementById('register-nombre').value.trim();
            const apellido = document.getElementById('register-apellido').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const phone = document.getElementById('register-phone').value.trim();
            const negocio = document.getElementById('register-negocio').value.trim();
            const password = document.getElementById('register-password').value;

            if (!rut || !nombre || !apellido || !email || !phone || !negocio || !password) {
                showNotification("Todos los campos son obligatorios.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await setDoc(doc(db, "users", user.uid), {
                    rut,
                    nombre,
                    apellido,
                    email,
                    phone,
                    negocio,
                    negocio_lowercase: negocio.toLowerCase(),
                    role: 'client',
                });
                
                showNotification('¡Registro exitoso! Serás redirigido.', 'success');
                sessionStorage.setItem('loggedInUserId', user.uid);
                setTimeout(() => {
                    window.location.href = getAbsoluteUrl('dashboard.html');
                }, 1500);

            } catch (error) {
                console.error("Registration Error:", error.code, error.message);
                if (error.code === 'auth/email-already-in-use') {
                    showNotification('Este correo electrónico ya está en uso.');
                } else if (error.code === 'auth/weak-password') {
                    showNotification('La contraseña debe tener al menos 6 caracteres.');
                } else {
                    showNotification('Error al registrar. Inténtalo de nuevo.');
                }
            }
        });
        
        function getAbsoluteUrl(filename) {
            return `${window.location.origin}/${filename}`;
        }
    </script>

    <!-- Modal de Registro -->
    <div id="register-modal" class="modal modal-hidden fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center z-50 p-4" aria-hidden="true">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
            <button id="close-register" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Crea tu cuenta en Repleno</h2>
                <p class="text-slate-500 mt-1">Es rápido y fácil.</p>
            </div>
            <form id="register-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="register-nombre" class="block text-sm font-medium text-slate-600 mb-1">Nombre</label>
                        <input type="text" id="register-nombre" placeholder="Tu nombre" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none" required>
                    </div>
                    <div>
                        <label for="register-apellido" class="block text-sm font-medium text-slate-600 mb-1">Apellido</label>
                        <input type="text" id="register-apellido" placeholder="Tu apellido" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none" required>
                    </div>
                </div>
                <div>
                    <label for="register-rut" class="block text-sm font-medium text-slate-600 mb-1">RUT</label>
                    <input type="text" id="register-rut" placeholder="12.345.678-9" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none" required>
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-slate-600 mb-1">Correo electrónico</label>
                    <input type="email" id="register-email" placeholder="tu@correo.com" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="register-phone" class="block text-sm font-medium text-slate-600 mb-1">Número telefónico</label>
                        <input type="tel" id="register-phone" placeholder="+56 9 1234 5678" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none" required>
                    </div>
                    <div>
                        <label for="register-negocio" class="block text-sm font-medium text-slate-600 mb-1">Nombre del negocio</label>
                        <input type="text" id="register-negocio" placeholder="Mi Negocio SpA" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none" required>
                    </div>
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-slate-600 mb-1">Contraseña</label>
                    <input type="password" id="register-password" placeholder="Mínimo 6 caracteres" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 outline-none" required>
                </div>
                <div class="flex items-start space-x-3 pt-2">
                    <input type="checkbox" id="accept-terms" class="mt-1 h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" required>
                    <label for="accept-terms" class="text-sm text-slate-600">
                        He leído y acepto los 
                        <button type="button" id="open-terms" class="font-medium text-indigo-600 hover:underline">Términos y Condiciones</button>.
                    </label>
                </div>
                <button type="submit" class="w-full btn-primary py-3 !mt-6">Crear mi cuenta</button>
            </form>
        </div>
    </div>

    <!-- Modal de Términos y Condiciones -->
    <div id="terms-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" aria-hidden="true">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-3xl relative max-h-[80vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-center text-slate-800">Términos y Condiciones</h2>
            <div class="text-sm text-gray-700 space-y-4">
                <p>Bienvenido a Repleno. Estos términos y condiciones describen las reglas y regulaciones para el uso del sitio web de Repleno. Esto nos ayudara para establecer reglas y limites claros para el uso de nuestro servicio.</p>
                <h3 class="font-semibold text-slate-700">1. Aceptación de los Términos</h3>
                <p>Al registrarse, acceder o utilizar nuestro servicio de subscripcion (en adelante el "servicio"), usted ("Cliente") acepta plenamente estos Terminos y Condiciones de uso junto con la politica de Privacidad del proveedor.
                    Si no esta de acuerdo con estos T&C, no debera utilizar el servicio. El uso continup del mismo constituira su aceptacion de los actuales T&C, incluida sus modificaciones. El proveedor podra modificar estos en cualquier
                    momento, dichas notificaciones seran notificadas mediante correo electronico registrado o a travez de la plataforma con 15 dias de anticipacion antes de su entrada en vigor. </p>
                <h3 class="font-semibold text-slate-700">2. Descripcion del servicio</h3>
                <p>El Servicio consiste en una plataforma de software como servicio (SaaS) basada en inteligencia artificial y machine learning, diseñada para predecir la demanda futura de productos y optimizar la gestión de inventario y
                    compras del cliente. El funcionamiento del sistema se basa en el análisis de datos históricos y operacionales proporcionados por el Cliente, incluyendo información de ventas, inventario y otras variables relevantes,
                    los cuales pueden ser cargados mediante archivos CSV u otros formatos compatibles. El Cliente comprende y acepta que: Las predicciones entregadas por el sistema son recomendaciones probabilísticas, no garantías de resultados.
                    El sistema puede sugerir o autorizar automáticamente órdenes de compra o venta, conforme a los umbrales de decisión configurados por el cliente. La decisión final de ejecución y las consecuencias comerciales o financieras derivadas
                    del uso del Servicio son de exclusiva responsabilidad del Cliente. El desempeño del modelo depende de la calidad, integridad y consistencia de los datos suministrados.</p>
                <h3 class="font-semibold text-slate-700">3. Modalidades de Subscripcion, pago  y renovacion </h3>
                <p>El Servicio se ofrece bajo una suscripción periódica (mensual, trimestral o anual), con pago anticipado. Precios: Los valores vigentes de suscripción se indican en la página web del Servicio. El Proveedor podrá modificarlos previo aviso
                   de 30 días conforme al artículo 28 de la Ley N° 19.496 sobre Protección de los Derechos de los Consumidores. Renovación: La suscripción se renovará automáticamente, salvo que el Cliente la cancele con al menos 7 días hábiles de anticipación
                    al vencimiento del período contratado. Cancelación: El Cliente podrá cancelar su suscripción en cualquier momento desde su panel de usuario. La cancelación surtirá efecto al término del ciclo vigente. No se otorgarán reembolsos por períodos
                     no utilizados, salvo disposición legal en contrario.</p>
                <h3 class="font-semibold text-slate-700">4. Obligaciones con el cliente y datos </h3>
                <p> El Cliente es responsable de que los datos cargados (ventas, inventario, precios, etc.) sean veraces, completos y legalmente obtenidos. Derechos sobre la Información: El Cliente declara contar con todos los derechos necesarios sobre los datos
                     que carga al sistema, manteniendo indemne al Proveedor ante cualquier reclamo de terceros. Uso Legítimo: El Cliente se compromete a utilizar el Servicio únicamente para fines comerciales legítimos, conforme a la legislación chilena aplicable.
                      Confidencialidad de Acceso: El Cliente deberá resguardar sus credenciales de acceso y notificar de inmediato cualquier uso no autorizado.</p>
                <h3 class="font-semibold text-slate-700">5. Propiedad intelectual</h3>
                <p>5. Todo el software, algoritmos de predicción, modelos estadísticos, diseños, interfaces y documentación asociados al Servicio son propiedad exclusiva del Proveedor y están protegidos por la legislación chilena e internacional sobre propiedad
                     intelectual e industrial. El Cliente conserva todos los derechos sobre los datos que carga y sobre los informes o resultados generados por el sistema. El Proveedor podrá utilizar dichos datos de manera anonimizada y agregada con fines estadísticos
                      o de mejora del modelo, sin identificar al Cliente o su negocio. Durante la vigencia de la suscripción, el Cliente recibe una licencia de uso no exclusiva, intransferible y revocable del Servicio.</p>
                <h3 class="font-semibold text-slate-700">6. Limitaciones de responsabilidad</h3>
                <p>El Proveedor no garantiza la exactitud, disponibilidad o rendimiento absoluto de las predicciones generadas por el Servicio. En ningún caso será responsable por: Pérdidas económicas derivadas de decisiones basadas en las predicciones (desabastecimiento,
                     exceso de stock, etc.). Interrupciones del Servicio por mantenimiento, actualizaciones o causas de fuerza mayor. Daños indirectos, incidentales o consecuentes. En conformidad con la legislación chilena, la responsabilidad máxima y acumulativa del Proveedor
                      no excederá el monto efectivamente pagado por el Cliente durante los tres (3) meses anteriores al evento que dio origen al reclamo.</p>
                <h3 class="font-semibold text-slate-700">7. Tratamiento de datos personales de acuerdo con la ley</h3>
                <p> la Ley N° 19.628 sobre Protección de la Vida Privada, el Proveedor actuará: Como Encargado del Tratamiento respecto de los datos de inventario, ventas y demás información operativa del Cliente. Como Responsable del Tratamiento respecto de los datos personales
                     de registro (nombre, correo, información de pago, etc.). El Cliente otorga su consentimiento expreso para el tratamiento de dichos datos con el fin de prestar, gestionar y mejorar el Servicio. El Proveedor implementará medidas técnicas y organizativas adecuadas
                      para proteger los datos contra acceso, alteración o divulgación no autorizada. Al finalizar la suscripción, los datos del Cliente serán eliminados de forma segura dentro de un plazo máximo de 30 días, salvo obligación legal de conservación.</p>
                <h3 class="font-semibold text-slate-700">8. Supension y terminacion del servicio</h3>
                <p>El Proveedor podrá suspender o cancelar el acceso al Servicio en caso de: Incumplimiento de los presentes T&C. Uso indebido, fraudulento o contrario a la ley. Falta de pago dentro del plazo establecido. En dichos casos, el Proveedor podrá eliminar los datos del
                     Cliente transcurridos 30 días desde la suspensión definitiva.</p>
                <h3 class="font-semibold text-slate-700">9. Ley aplicable y jurisdiccion</h3>
                <p>Estos T&C se rigen por las leyes de la República de Chile. Cualquier controversia será sometida a los tribunales ordinarios de justicia de la ciudad de Santiago, sin perjuicio de que las partes procuren previamente una solución mediante mecanismos de mediación o arbitraje voluntario.</p>
            </div>
            <button id="close-terms" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>

</body>
</html>
